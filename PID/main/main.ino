#include "angle.h"
#include "H_Bridge.h"
#include <PID_v1.h>
//#include <PID_AutoTune_v0.h>
#define PC_DEBUG
#define VALUE 80
#define SETPOINT 135
//#define SETPOINT 45 //No anda bien, habria que sacar peso y retocar valores.
#define NPOLE 1
#define NZERO 1
#define ANGLE_OFFSET 1
#define SAMPLE_TIME_IN_MS 5
#define INITIAL_ANGLE 90

typedef double REAL;
REAL acoeff[]={-0.9964444320905282,1};
REAL bcoeff[]={1,1};
REAL gain=562.4980455786416;
REAL xv[]={45.0,45.0};
REAL yv[]={45.0,45.0};

REAL applyfilter(REAL v)
{
  int i;
  REAL out=0;
  for (i=0; i<NZERO; i++) {xv[i]=xv[i+1];}
  xv[NZERO] = v/gain;
  for (i=0; i<NPOLE; i++) {yv[i]=yv[i+1];}
  for (i=0; i<=NZERO; i++) {out+=xv[i]*bcoeff[i];}
  for (i=0; i<NPOLE; i++) {out-=yv[i]*acoeff[i];}
  yv[NPOLE]=out;
  return out;
}


/* ultimos valores 15/2 */
/*double kp = 1.1;
double ki = 0.3/(SAMPLE_TIME_IN_MS/5);
double kd = 0.6*(SAMPLE_TIME_IN_MS/5);*/

/* ultimos valores 20/2
double kp = 1.42;
double ki = 3.305/(SAMPLE_TIME_IN_MS/5);
double kd = 0.575*(SAMPLE_TIME_IN_MS/5);*/

//double kp = 1.2;
double ki = 0/(SAMPLE_TIME_IN_MS/5);
//double kd = 0.425*(SAMPLE_TIME_IN_MS/5);

double kp = 0.9;
double kd = 0;

//91.11,91.17,91.04,91.07,91.13,91.25,91.15,91.12,91.10,91.23,91.29,91.20,91.30,91.42,91.37,91.49,91.41,91.47,91.37,91.54,91.90,91.82,92.05,92.40,92.39,92.55,92.31,92.59,92.66,92.60,92.54,92.59,92.64,92.66,92.84,93.18,93.38,93.10,92.86,92.77,93.13,93.44,93.42,93.09,93.14,93.18,93.43,93.05,93.36,92.91,92.64,92.74,92.54,92.30,92.56,92.85,93.30,93.75,93.84,93.49,93.50,93.39,93.37,93.29,93.41,93.79,94.42,94.30,93.99,94.28,94.59,95.00,95.44,96.05,96.26,96.68,96.72,97.68,98.12,98.77,99.23,99.89,99.78,100.00,99.91,100.26,100.62,101.60,101.78,102.63,103.06,103.63,104.40,104.85,105.13,106.17,106.83,107.14,107.97,108.42,108.65,108.89,109.45,109.87,109.96,110.34,110.44,111.25,111.74,112.05,112.22,112.95,113.32,114.13,114.51,115.26,115.49,115.69,116.00,115.98,116.32,116.62,116.79,117.38,117.49,117.69,118.05,118.23,118.72,119.04,119.46,119.95,120.40,120.88,120.91,121.06,121.26,121.75,121.92,122.27,122.26,122.39,122.63,122.78,123.28,123.40,123.60,123.83,124.14,124.40,124.46,124.44,124.80,125.10,125.25,125.56,125.57,125.55,125.68,125.75,125.85,125.98,126.19,126.18,126.31,126.54,126.48,126.55,126.50,126.29,126.33,126.36,126.37,126.37,126.21,126.04,125.94,126.03,125.99,126.02,125.76,125.77,125.59,125.35,125.20,124.99,124.70,124.52,124.37,124.25,123.96,123.59,123.33,123.11,122.79,122.48,122.30,122.05,121.66,121.41,121.10,120.86,120.56,120.33,119.91,119.58,119.23,118.94,118.69,118.27,117.98,117.59,117.16,116.77,116.34,115.83,115.69,115.48,115.24,114.84,114.25,113.83,113.53,113.25,112.89,112.69,112.42,111.83,111.49,111.01,110.57,110.38,109.74,109.17,108.93,108.40,107.91,107.55,107.19,107.01,106.44,106.08,105.81,105.67,105.17,104.85,104.59,103.87,103.57,103.47,102.87,102.55,102.37,101.71,101.34,101.31,100.78,100.80,100.63,100.44,100.28,99.87,99.71,99.49,99.26,99.03,98.87,98.60,98.31,97.77,97.39,97.07,97.26,96.65,97.07,96.93,96.70,96.64,96.41,96.00,96.28,95.68,95.86,95.55,95.48,95.66,95.66,95.55,95.86,95.60,95.16,95.33,95.16,95.11,95.11,95.29,95.91,96.40,96.54,96.36,96.53,96.53,96.95,97.13,97.12,97.20,97.72,97.91,98.56,98.81,99.14,99.21,98.94,98.97,99.46,99.60,100.26,100.52,100.55,100.71,100.78,101.48,101.83,101.97,101.79,101.64,101.70,102.35,102.34,102.44,102.65,103.06,103.25,103.84,103.94,104.19,104.48,104.73,104.58,104.96,105.56,105.73,105.71,106.09,106.27,106.76,107.57,108.06,108.64,109.20,109.36,109.55,110.12,110.23,110.69,110.90,111.57,112.08,112.56,112.52,113.03,113.46,113.65,114.23,115.00,115.25,115.59,116.33,116.70,117.13,117.76,118.04,118.12,118.32,118.26,118.49,118.63,118.85,119.43,119.91,120.34,120.85,121.29,121.75,122.06,122.25,122.90,122.94,123.11,123.08,123.49,123.69,123.86,124.13,124.64,124.66,124.80,124.92,125.06,125.51,125.59,125.98,126.18,126.39,126.51,126.45,126.64,126.41,126.41,126.35,126.35,126.44,126.48,126.49,126.49,126.61,126.64,126.55,126.54,126.50,126.38,126.25,126.12,126.05,126.01,125.81,125.71,125.58,125.52,125.41,125.40,125.14,124.97,124.75,124.72,124.52,124.47,124.40,124.05,123.71,123.48,123.16,123.06,122.90,122.64,122.42,122.07,121.86,121.74,121.44,121.05,120.65,120.47,120.30,120.14,119.74,119.30,118.91,118.57,118.22,118.02,117.72,117.24,117.07,116.70,116.40,116.39,116.09,115.70,115.20,114.94,114.61,114.02,113.50,113.10,112.67,112.36,112.02,111.90,111.39,110.82,110.28,109.91,109.39,109.07,108.54,108.19,107.72,107.37,107.21,106.78,106.22,105.90,105.51,105.29,105.08,104.88,104.45,103.81,103.73,103.05,103.01,102.77,102.49,101.72,101.32,101.10,100.85,100.68,100.55,100.24,99.94,99.64,99.67,99.43,99.22,98.75,98.16,97.62,97.44,97.14,96.56,96.08,95.69,95.55,95.63,95.67,95.41,95.69,95.29,95.00,95.13,94.71,94.47,94.84,94.47,94.60,94.57,94.80,95.00,94.94,94.61,94.18,94.13,94.58,94.94,95.44,95.46,95.70,95.75,96.03,95.97,96.16,96.44,96.49,96.56,96.73,96.86,96.91,97.38,97.73,98.11,98.04,98.29,98.78,98.84,98.92,98.97,99.69,100.23,100.92,101.03,101.33,101.55,101.41,101.71,102.47,102.77,103.35,103.81,103.91,104.12,104.57,104.81,105.16,105.79,105.91,106.20,106.57,106.61,106.94,106.79,106.94,107.46,107.35,107.34,107.66,107.93,107.93,108.88,108.81,109.45,109.68,110.12,110.23,111.08,111.19,111.14,111.44,111.91,112.56,113.28,113.68,114.47,114.97,115.27,115.66,116.34,116.42,117.06,117.72,118.06,118.59,119.09,119.28,119.77,119.68,119.78,120.20,120.78,120.83,121.22,121.40,121.47,121.99,122.58,122.74,123.04,123.21,123.38,123.46,123.61,123.53,123.96,124.33,124.58,124.93,125.01,125.27,125.56,125.79,126.08,126.15,126.44,126.46,126.68,126.97,127.02,126.82,126.93,126.87,126.81,126.83,126.86,126.82,126.79,126.83,126.92,126.94,126.84,126.79,126.75,126.63,126.53,126.57,126.37,126.25,126.19,126.14,125.98,125.81,125.71,125.71,125.49,125.34,125.23,125.20,125.04,124.94,124.72,124.37,124.21,123.87,123.71,123.43,122.97,122.66,122.39,122.12,121.73,121.43,121.26,120.86,120.70,120.46,119.96,119.51,119.15,118.84,118.70,118.27,117.97,117.58,117.07,116.64,116.45,116.24,115.83,115.43,114.90,114.35,114.03,113.60,113.13,112.87,112.49,111.87,111.63,111.27,110.81,110.42,109.99,109.67,109.43,108.88,108.30,108.10,107.50,107.26,106.79,106.35,105.90,105.56,105.23,104.70,104.69,104.48,104.48,104.15,103.81,103.44,103.29,102.80,102.68,102.29,101.78,101.56,101.27,101.21,100.72,100.33,100.20,100.05,99.80,99.00,98.62,97.97,98.02,97.78,97.78,97.39,96.51,96.66,96.71,96.35,95.87,95.88,95.85,95.73,95.44,95.30,94.83,94.91,94.81,94.55,94.56,94.93,95.00,94.75,94.58,94.33,94.57,95.11,95.38,95.43,95.32,95.49,95.50,96.17,96.41,95.94,96.48,96.20,95.87,95.82,95.71,96.27,96.56,96.75,97.21,97.31,97.64,97.80,97.88,98.14,97.69,97.90,98.65,99.37,99.80,100.01,100.12,100.72,101.00,101.04,101.45,101.65,102.05,102.34,102.32,103.22,104.05,104.12,104.67,104.96,105.27,105.61,105.75,106.16,106.51,106.69,106.52,107.20,107.74,107.99,108.17,108.28,108.50,108.60,108.95,109.33,109.53,109.69,109.82,110.24,110.72,111.32,111.52,111.71,112.43,112.80,113.35,113.85,114.19,114.46,114.79,115.62,116.03,116.38,116.77,116.95,117.30,117.73,118.32,118.57,119.24,119.57,119.76,120.08,120.49,121.11,121.51,121.73,121.85,122.00,122.30,122.82,123.16,123.21,123.34,123.66,124.10,124.40,124.64,124.67,125.09,125.69,126.05,126.20,126.21,126.26,126.47,126.51,126.68,126.86,127.16,127.30,127.42,127.50,127.68,127.73,127.80,127.78,127.71,127.55,127.67,127.71,127.64,127.53,127.40,127.36,127.24,127.08,126.87,126.77,126.70,126.63,126.48,126.39,126.26,126.11,126.00,125.74,125.54,125.33,125.24,125.01,124.83,124.64,124.48,124.25,124.07,123.91,123.67,123.42,123.17,122.89,122.76,122.39,122.12,121.92,121.59,121.14,120.75,120.40,120.20,119.83,119.39,118.99,118.73,118.26,117.82,117.50,117.07,116.93,116.48,116.04,115.57,115.13,114.60,114.36,113.94,113.78,113.45,113.09,112.61,112.32,111.81,111.57,111.06,110.53,110.18,109.80,109.40,108.88,108.60,108.28,107.83,107.29,106.98,106.28,105.79,105.42,105.27,105.03,104.71,104.17,103.64,103.26,102.73,102.47,101.98,101.43,101.25,101.01,100.73,100.60,100.15,99.64,99.56,99.45,99.43,99.31,98.94,98.87,98.86,98.73,98.58,98.58,98.53,98.42,97.69,97.61,97.11,97.15,97.36,97.06,96.80,96.70,96.39,96.52,96.33,96.46,96.45,96.79,96.70,96.60,96.12,95.52,95.46,95.40,95.62,94.91,95.07,94.86,94.96,94.73,94.66,95.25,95.09,95.91,96.20,96.66,96.60,97.07,97.47,98.08,98.57,98.40,98.35,98.49,98.14,98.58,98.66,99.33,99.53,100.30,100.43,100.54,100.94,101.36,101.54,101.93,102.20,102.77,102.98,103.47,103.44,103.38,103.34,103.40,103.73,103.51,103.67,103.82,104.04,104.23,104.71,104.90,105.16,105.59,105.88,106.48,106.67,107.10,107.65,108.79,108.90,109.65,110.23,110.33,110.72,111.03,111.41,111.86,112.83,113.21,113.79,114.27,114.73,115.37,115.71,116.20,116.50,116.67,117.29,118.06,118.46,118.73,118.67,118.99,119.00,119.38,119.42,119.83,120.01,120.24,120.69,120.90,120.99,121.44,121.78,122.05,122.07,122.21,122.33,122.93,123.44,123.75,124.16,124.48,124.78,125.02,125.28,125.41,125.47,125.71,125.86,126.37,126.56,126.49,126.66,126.76,126.79,126.76,126.80,127.08,127.15,127.16,127.22,127.32,127.53,127.59,127.57,127.50,127.36,127.30,127.15,127.09,127.18,127.04,127.01,126.90,126.90,126.66,126.45,126.43,126.37,126.30,126.23,126.07,125.99,125.75,125.73,125.43,125.24,125.08,124.88,124.50,124.35,124.15,124.07,123.79,123.52,123.18,122.91,122.61,122.27,121.91,121.73,121.42,121.16,120.83,120.49,120.22,119.91,119.51,119.35,118.89,118.32,118.04,117.62,117.33,117.14,116.72,116.28,115.98,115.87,115.49,115.06,114.54,114.05,113.71,113.28,112.93,112.68,112.53,112.07,111.73,111.24,110.70,110.50,110.30,109.83,109.38,109.01,108.74,108.57,108.31,107.90,107.37,106.97,106.34,106.12,105.86,105.72,105.20,104.63,104.20,104.05,103.62,103.06,102.82,102.55,102.20,102.04,101.80,101.28,101.26,101.09,100.55,100.07,99.72,99.11,98.53,97.97,98.09,98.20,98.31,98.09,98.14,97.94,97.45,97.26,97.04,97.07,97.00,96.87,96.59,96.28,95.99,96.13,95.81,95.85,95.71,95.48,95.15,95.01,94.92,94.87,95.08,95.47,95.49,94.84,94.36,94.13,94.61,94.48,94.80,95.03,95.50,95.57,95.20,94.96,94.99,95.70,96.06,96.18,96.09,96.10,96.49,96.31,96.65,97.68,97.95,97.79,98.47,98.63,98.82,99.37,100.02,100.65,100.84,100.56,100.87,100.93,101.08,101.12,101.91,102.58,103.01,102.90,102.94,103.47,103.63,104.24,104.31,104.86,105.41,105.90,106.01,106.48,106.71,106.50,106.67,106.73,106.83,107.31,107.59,107.83,108.41,108.93,109.45,109.32,109.36,109.39,109.93,110.10,110.35,110.95,111.26,111.50,112.27,112.75,113.30,113.51,113.77,114.04,114.57,115.17,116.00,116.21,116.69,116.83,117.21,117.43,117.75,117.93,118.09,118.00,118.18,118.52,119.09

HBRIDGE hb;
float input, output, setPoint;
bool clamped;
bool stop_bool;
unsigned long int prevTime, curTime, elapsedTime;

double Setpoint, Input, Output;
//                                    Kp, Ki, Kd
//PID myPID(&Input, &Output, &Setpoint, 1,0,0 , DIRECT);
//PID myPID(&Input, &Output, &Setpoint, 2,1.1,4, DIRECT);
PID myPID(&Input, &Output, &Setpoint, kp, ki, kd, DIRECT);

//PID_ATune aTune(&Input, &Output);
#define NUM_SAMPLES 50
double avg_buffer[NUM_SAMPLES];
int pointer;

void init_buffer(void){
  unsigned int i;
  for(i=0;i<NUM_SAMPLES;i++){
    avg_buffer[i]=INITIAL_ANGLE;
  }
}

void add_to_buffer(double angle)
{
  avg_buffer[pointer % NUM_SAMPLES] = angle;
  pointer++;
}

double get_filt_out(double angle)
{
  add_to_buffer(angle);
  double aux = 0;
  for (int i = 0; i < NUM_SAMPLES; i++)
  {
    aux += avg_buffer[i];
  }
  return aux / (double)NUM_SAMPLES;
}

bool goingFoward;
void setup(void)
{

  Setpoint = SETPOINT;

  Serial.begin(115200);
  init_buffer();
  init_mpu();
  hb.H_Bridge_Init(8, 7, 3); //Motor Plus, Minus and PWM
  hb.H_Bridge_Set_Dir(H_FOWARD);
  digitalWrite(13, HIGH);
  stop_bool = false;
  myPID.SetMode(AUTOMATIC); //AUTOMATIC);
  myPID.SetOutputLimits(-VALUE, VALUE);
  goingFoward = true;
  pinMode(13, OUTPUT);
  digitalWrite(13, LOW);
  //myPID.SetSampleTime(SAMPLE_TIME_IN_MS);
  //myPID.SetIntegralError(80);
  prevTime = millis();
}

void loop(void)
{ 
  static float angle = 0.0f;
  curTime = millis();
  elapsedTime = curTime - prevTime;
  angle = (get_angle() * 180 / PI); //read angle in degrees
  if(angle < 0){
    angle += 360.0;  
  }
  angle = get_filt_out(angle) + ANGLE_OFFSET;
  Input = angle;
  if(elapsedTime >= SAMPLE_TIME_IN_MS){
    myPID.SetSampleTime(elapsedTime);
    //Setpoint = applyfilter(SETPOINT);
    myPID.Compute();
    //Serial.print("Output: ");
    //Serial.print(Output);
    Serial.print(angle);
    Serial.print(",");
    
    uint8_t aux = (uint8_t)abs(Output);
    if (Output > 0)
    {
      hb.H_Bridge_Set_Dir(H_FOWARD);
      digitalWrite(13, HIGH);
    }
    else
    {
      hb.H_Bridge_Set_Dir(H_BACKWARD);
      digitalWrite(13, LOW);
      aux=aux*2;
    }
    hb.H_Bridge_Set_Pwm(aux);
    prevTime = curTime;
  }
}
